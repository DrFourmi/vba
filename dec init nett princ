Global dateJour As Date
Global jourNumero As String
Global moisNumero As String
Global moisNom As String
Global anneeNumero As String
Global wbGOMST As String
Global wsGOMST As String
Global wbGOMSSDaily As String
Global wsGOMSSDaily As String
Global wbGOMSSMonthly As String
Global wsGOMSSMonthly As String
Global wbGOMSSYTD As String
Global wsGOMSSYTD As String
Global wbTemplateS As String
Global arretMacro As Boolean

Global transaction() As order

Global tabSecondaryDMGovFunds() As secondaryMarket
Global tabSecondaryDMCredFunds() As secondaryMarket
Global tabSecondaryEMGovHardFunds() As secondaryMarket
Global tabSecondaryEMGovLocalFunds() As secondaryMarket
Global tabSecondaryEMGovFunds() As secondaryMarket
Global tabSecondaryEMCredHardFunds() As secondaryMarket
Global tabSecondaryEMCredLocalFunds() As secondaryMarket
Global tabSecondaryEMCredFunds() As secondaryMarket
Global tabSecondaryDMGovMandates() As secondaryMarket
Global tabSecondaryDMCredMandates() As secondaryMarket
Global tabSecondaryEMGovHardMandates() As secondaryMarket
Global tabSecondaryEMGovLocalMandates() As secondaryMarket
Global tabSecondaryEMGovMandates() As secondaryMarket
Global tabSecondaryEMCredHardMandates() As secondaryMarket
Global tabSecondaryEMCredLocalMandates() As secondaryMarket
Global tabSecondaryEMCredMandates() As secondaryMarket

Global tabSecondaryConsoDMGov() As secondaryMarket
Global tabSecondaryConsoDMCred() As secondaryMarket
Global tabSecondaryConsoEMGovHard() As secondaryMarket
Global tabSecondaryConsoEMGovLocal() As secondaryMarket
Global tabSecondaryConsoEMGov() As secondaryMarket
Global tabSecondaryConsoEMCredHard() As secondaryMarket
Global tabSecondaryConsoEMCredLocal() As secondaryMarket
Global tabSecondaryConsoEMCred() As secondaryMarket
Global tabSecondaryConsoGov() As secondaryMarket
Global tabSecondaryConsoCred() As secondaryMarket

Global tabPrimaryDMGovFunds() As secondaryMarket
Global tabPrimaryDMCredFunds() As secondaryMarket
Global tabPrimaryEMGovHardFunds() As secondaryMarket
Global tabPrimaryEMGovLocalFunds() As secondaryMarket
Global tabPrimaryEMGovFunds() As secondaryMarket
Global tabPrimaryEMCredHardFunds() As secondaryMarket
Global tabPrimaryEMCredLocalFunds() As secondaryMarket
Global tabPrimaryEMCredFunds() As secondaryMarket
Global tabPrimaryDMGovMandates() As secondaryMarket
Global tabPrimaryDMCredMandates() As secondaryMarket
Global tabPrimaryEMGovHardMandates() As secondaryMarket
Global tabPrimaryEMGovLocalMandates() As secondaryMarket
Global tabPrimaryEMGovMandates() As secondaryMarket
Global tabPrimaryEMCredHardMandates() As secondaryMarket
Global tabPrimaryEMCredLocalMandates() As secondaryMarket
Global tabPrimaryEMCredMandates() As secondaryMarket

Global tabPrimaryConsoDMGov() As secondaryMarket
Global tabPrimaryConsoDMCred() As secondaryMarket
Global tabPrimaryConsoEMGovHard() As secondaryMarket
Global tabPrimaryConsoEMGovLocal() As secondaryMarket
Global tabPrimaryConsoEMGov() As secondaryMarket
Global tabPrimaryConsoEMCredHard() As secondaryMarket
Global tabPrimaryConsoEMCredLocal() As secondaryMarket
Global tabPrimaryConsoEMCred() As secondaryMarket
Global tabPrimaryConsoGov() As secondaryMarket
Global tabPrimaryConsoCred() As secondaryMarket

Global tabTotalBrokerDealers() As totalBrokerDealers
Global tabTotalBrokerDealersEMHard() As totalBrokerDealers
Global tabTotalBrokerDealersEMLocal() As totalBrokerDealers
Global tabTotalBrokerDealersEM() As totalBrokerDealers

Global collecOrder() As tabCollection

Global countryAmt() As instrumentCountry
Global EMOnlyAmtHard() As instrumentEMOnly
Global EMOnlyAmtLocal() As instrumentEMOnly
Global EMOnlyAmt() As instrumentEMOnly
Global segmentAmt() As instrumentSegment
Global maturityAmt As instrumentMaturityAndOutstandingAmtAndNominal
Global outstandingAmt As instrumentMaturityAndOutstandingAmtAndNominal
Global nominalAmt As instrumentMaturityAndOutstandingAmtAndNominal
Global venues() As tradingVenues
Global instrumentCapitalStructure() As capitalStructure

Global chiffresBroker() As brokerNumbers

Global Const wbTemplate = "Fixed Income Statistics.xlsm"
Global Const wsTemplate1 = "Business overview"
Global Const wsTemplate2 = "Secondary market"
Global Const wsTemplate3 = "Secondary market Conso"
Global Const wsTemplate4 = "Primary market"
Global Const wsTemplate5 = "Primary market Conso"
Global Const wsTemplate6 = "Broker-dealers"
Global Const wsTemplate7 = "Broker-dealers EM only"
Global Const wsTemplate8 = "Countries EM only"
Global Const wsTemplate9 = "Additional information"
Global Const wsTemplate10 = "Tables"
Global Const cheminGOMST = ""
Global Const cheminGOMSS = ""
Global Const cheminTemplateS = ""

Public Type order
    account As String
    assetClass As String
    secType As String
    orderID As Variant
    broker As String
    tradeDate As Date
    settlementDate As Date
    buy As Boolean
    sell As Boolean
    currency As String
    nominal As Variant
    grossAmount As Variant
    price As Variant
    trader As String
    manager As String
    instruction As String
    tradingVenue As String
    losingQuote(1 To 5) As String
    issuer As String
    issueQuantity As Variant
    issueDate As Date
    primaryIssue As Boolean
    maturity As Variant
    govies As Boolean
    credits As Boolean
    financial As Boolean
    businessUnit As String
    capitalStructure As String
    segment As String
    localCcy As Boolean
    isin As String
    secName As String
End Type

Public Type secondaryMarket
    broker As String
    tiering As String
    amtDone As Variant
    amtReq As Variant
    dealDone As Long
    dealReq As Long
End Type

Public Type brokerNumbers
    name As String
    tiering As String
    nbDealsDone As Long
    amount As Variant
    nbDealsRqt As Long
    amountRqt As Variant
    mktShare As Variant
    mktDeal As Variant
    rankDone As Integer
    RankRqt As Integer
    hitAmt As Variant
    hitDeal As Variant
End Type

Public Type totalBrokerDealers
    broker As String
    secondary As Variant
    primary As Variant
    dealDoneSecondary As Long
    dealDonePrimary As Long
End Type

Public Type instrumentCountry
    country As String
    amtBuyGov As Variant
    amtBuyFin As Variant
    amtBuyCorp As Variant
    amtSellGov As Variant
    amtSellFin As Variant
    amtSellCorp As Variant
End Type

Public Type instrumentEMOnly
    country As String
    amtBuyGov As Variant
    amtBuyCorp As Variant
    amtSellGov As Variant
    amtSellCorp As Variant
    dealDoneBuyGov As Variant
    dealDoneBuyCorp As Variant
    dealDoneSellGov As Variant
    dealDoneSellCorp As Variant
End Type

Public Type instrumentSegment
    segment As String
    amtBuyGov As Variant
    amtBuyFin As Variant
    amtBuyCorp As Variant
    amtSellGov As Variant
    amtSellFin As Variant
    amtSellCorp As Variant
End Type

Public Type instrumentMaturityAndOutstandingAmtAndNominal
    buyGovSup As Variant
    buyGovMin As Variant
    buyFinSup As Variant
    buyFinMin As Variant
    buyCorpSup As Variant
    buyCorpMin As Variant
    sellGovSup As Variant
    sellGovMin As Variant
    sellFinSup As Variant
    sellFinMin As Variant
    sellCorpSup As Variant
    sellCorpMin As Variant
End Type

Public Type tradingVenues
    tdVenue As String
    amtBuyGov As Variant
    amtBuyFin As Variant
    amtBuyCorp As Variant
    amtSellGov As Variant
    amtSellFin As Variant
    amtSellCorp As Variant
End Type

Public Type capitalStructure
    KStructure As String
    amtBuyGov As Variant
    amtBuyFin As Variant
    amtBuyCorp As Variant
    amtSellGov As Variant
    amtSellFin As Variant
    amtSellCorp As Variant
End Type

Public Type tabCollection
    ID As String
    somme As Variant
    comptabilisee As Boolean
End Type


Option Explicit
Option Base 1

Sub initialiser()

arretMacro = False

jourNumero = Mid(dateJour, 1, 2)
moisNumero = Mid(dateJour, 4, 2)
moisNom = MonthName(Month(dateJour))
anneeNumero = Year(dateJour)

wbGOMST = "GOMS_StatisticsBrokerComm_" & Format(dateJour, "yyyymmdd") & ".csv"
wsGOMST = "GOMS_StatisticsBrokerComm_" & Format(dateJour, "yyyy") & Mid(dateJour, 4, 1)

wbGOMSSDaily = "GOMS_StatisticsBrokerComm_" & Format(dateJour, "yyyymmdd") & "_Fixed Income_daily" & ".csv"
wsGOMSSDaily = "GOMS_StatisticsBrokerComm_" & Format(dateJour, "yyyy") & Mid(dateJour, 4, 1)

wbGOMSSMonthly = "GOMS_StatisticsBrokerComm_" & Format(dateJour, "yyyymm") & "_Fixed Income_monthly" & ".csv"
wsGOMSSMonthly = "GOMS_StatisticsBrokerComm_" & Format(dateJour, "yyyy") & Mid(dateJour, 4, 1)

wbGOMSSYTD = "GOMS_StatisticsBrokerComm_" & Format(dateJour, "yyyy") & "_Fixed Income_YTD" & ".csv"
wsGOMSSYTD = "GOMS_StatisticsBrokerComm_" & Format(dateJour, "yyyy") & "_"

wbTemplateS = "Fixed Income Statistics " & jourNumero & "_" & moisNumero & "_" & anneeNumero & ".xls"

End Sub



Option Explicit
Option Base 1

Sub viderDaily()

Call viderBusinessOverview
Call viderBrokerDealers
Call viderBrokerDealersEMOnly
Call viderCountriesEMOnly
Call viderAdditionalInformation

End Sub

Sub viderBusinessOverview()

Workbooks(wbTemplate).Worksheets(wsTemplate1).Activate

Dim a As Long, b As Long, c As Long
Dim row As Long
Dim col As String

For a = 1 To 2
    If a = 1 Then
        col = "C"
        row = 10
    ElseIf a = 2 Then
        col = "J"
        row = 10
    End If
    
    For b = 0 To 1
        For c = 0 To 2
            Range(col & row).Offset(c, b) = 0
        Next
        
        For c = 5 To 6
            Range(col & row).Offset(c, b) = 0
        Next
        
        For c = 9 To 10
            Range(col & row).Offset(c, b) = 0
        Next
    Next
Next

End Sub

Sub viderBrokerDealersEMOnly()

Workbooks(wbTemplate).Worksheets(wsTemplate7).Activate

Dim a As Long, b As Long, c As Long
Dim row As Long
Dim derniereLigne As Long
Dim col As String

For a = 1 To 18
    If a = 1 Then
        col = "C"
        row = 11
        derniereLigne = calculLastRow(col, row) + 1
    ElseIf a = 2 Then
        col = "G"
        row = 11
        derniereLigne = calculLastRow(col, row) + 1
    ElseIf a = 3 Then
        col = "M"
        row = 11
        derniereLigne = calculLastRow(col, row) + 1
    ElseIf a = 4 Then
        col = "Q"
        row = 11
        derniereLigne = calculLastRow(col, row) + 1
    ElseIf a = 5 Then
        col = "W"
        row = 11
        derniereLigne = calculLastRow(col, row) + 1
    ElseIf a = 6 Then
        col = "AA"
        row = 11
        derniereLigne = calculLastRow(col, row) + 1
    ElseIf a = 7 Then
        col = "AG"
        row = 11
        derniereLigne = calculLastRow(col, row) + 1
    ElseIf a = 8 Then
        col = "AK"
        row = 11
        derniereLigne = calculLastRow(col, row) + 1
    ElseIf a = 9 Then
        col = "AQ"
        row = 11
        derniereLigne = calculLastRow(col, row) + 1
    ElseIf a = 10 Then
        col = "AU"
        row = 11
        derniereLigne = calculLastRow(col, row) + 1
    ElseIf a = 11 Then
        col = "BA"
        row = 11
        derniereLigne = calculLastRow(col, row) + 1
    ElseIf a = 12 Then
        col = "BE"
        row = 11
        derniereLigne = calculLastRow(col, row) + 1
    ElseIf a = 13 Then
        col = "BK"
        row = 11
        derniereLigne = calculLastRow(col, row) + 1
    ElseIf a = 14 Then
        col = "BP"
        row = 11
        derniereLigne = calculLastRow(col, row) + 1
    ElseIf a = 15 Then
        col = "BW"
        row = 11
        derniereLigne = calculLastRow(col, row) + 1
    ElseIf a = 16 Then
        col = "CB"
        row = 11
        derniereLigne = calculLastRow(col, row) + 1
    ElseIf a = 17 Then
        col = "CI"
        row = 11
        derniereLigne = calculLastRow(col, row) + 1
    ElseIf a = 18 Then
        col = "CN"
        row = 11
        derniereLigne = calculLastRow(col, row) + 1
    End If
    
    For b = row To derniereLigne
        Range(col & b) = 0
    Next
    
Next

End Sub

Sub viderBrokerDealers()

Workbooks(wbTemplate).Worksheets(wsTemplate6).Activate

Dim a As Long, b As Long, c As Long
Dim row As Long
Dim derniereLigne As Long
Dim col As String

For a = 1 To 6
    If a = 1 Then
        col = "C"
        row = 11
        derniereLigne = calculLastRow(col, row) + 1
    ElseIf a = 2 Then
        col = "G"
        row = 11
        derniereLigne = calculLastRow(col, row) + 1
    ElseIf a = 3 Then
        col = "M"
        row = 11
        derniereLigne = calculLastRow(col, row) + 1
    ElseIf a = 4 Then
        col = "Q"
        row = 11
        derniereLigne = calculLastRow(col, row) + 1
    ElseIf a = 5 Then
        col = "W"
        row = 11
        derniereLigne = calculLastRow(col, row) + 1
    ElseIf a = 6 Then
        col = "AB"
        row = 11
        derniereLigne = calculLastRow(col, row) + 1
    End If
    
    For b = row To derniereLigne
        Range(col & b) = 0
    Next
    
Next

End Sub

Sub viderCountriesEMOnly()

Workbooks(wbTemplate).Worksheets(wsTemplate8).Activate

Dim a As Long, b As Long, c As Long
Dim col As String, colPays As String
Dim derniereLigneEM(6) As Long
Dim rowEM(6) As Long

For a = 1 To 12
    If a = 1 Then
        col = "C"
        colPays = "B"
        rowEM(1) = 12
    ElseIf a = 2 Then
        col = "F"
        colPays = "B"
        rowEM(1) = 12
    ElseIf a = 3 Then
        col = "J"
        colPays = "B"
        rowEM(1) = 12
    ElseIf a = 4 Then
        col = "M"
        colPays = "B"
        rowEM(1) = 12
    ElseIf a = 5 Then
        col = "S"
        colPays = "R"
        rowEM(1) = 12
    ElseIf a = 6 Then
        col = "V"
        colPays = "R"
        rowEM(1) = 12
    ElseIf a = 7 Then
        col = "Z"
        colPays = "R"
        rowEM(1) = 12
    ElseIf a = 8 Then
        col = "AC"
        colPays = "R"
        rowEM(1) = 12
    ElseIf a = 9 Then
        col = "AI"
        colPays = "AH"
        rowEM(1) = 12
    ElseIf a = 10 Then
        col = "AL"
        colPays = "AH"
        rowEM(1) = 12
    ElseIf a = 11 Then
        col = "AP"
        colPays = "AH"
        rowEM(1) = 12
    ElseIf a = 12 Then
        col = "AS"
        colPays = "AH"
        rowEM(1) = 12
    End If
    
    For b = 1 To 6
        If b > 1 Then
            rowEM(b) = derniereLigneEM(b - 1) + 5
        End If
        
        If Range(colPays & rowEM(b)).Offset(1, 0) <> "" Then
            derniereLigneEM(b) = calculLastRow(col, rowEM(b)) + 1
        Else
            derniereLigneEM(b) = rowEM(b)
        End If
    Next
    
    For b = 1 To 6
        For c = rowEM(b) To derniereLigneEM(b)
            Range(col & c) = 0
        Next
        
        If b = 6 Then
            Range(col & derniereLigneEM(6)).Offset(4, 0) = 0
        End If
    Next
    
Next

End Sub

Sub viderAdditionalInformation()

Workbooks(wbTemplate).Worksheets(wsTemplate9).Activate

Dim a As Long, b As Long, c As Long
Dim row(3) As Long
Dim derniereLigne(3) As Long
Dim col As String

For a = 1 To 14
    If a = 1 Then
        col = "C"
        row(1) = 11
    ElseIf a = 2 Then
        col = "G"
        row(1) = 11
    ElseIf a = 3 Then
        col = "M"
        row(1) = 11
    ElseIf a = 4 Then
        col = "Q"
        row(1) = 11
    ElseIf a = 5 Then
        col = "W"
        row(1) = 11
    ElseIf a = 6 Then
        col = "AA"
        row(1) = 11
    ElseIf a = 7 Then
        col = "AG"
        row(1) = 11
    ElseIf a = 8 Then
        col = "AK"
        row(1) = 11
    ElseIf a = 9 Then
        col = "AQ"
        row(1) = 11
    ElseIf a = 10 Then
        col = "AU"
        row(1) = 11
    ElseIf a = 11 Then
        col = "BA"
        row(1) = 11
    ElseIf a = 12 Then
        col = "BE"
        row(1) = 11
    ElseIf a = 13 Then
        col = "BK"
        row(1) = 11
    ElseIf a = 14 Then
        col = "BO"
        row(1) = 11
    End If
    
    For b = 1 To 3
        If b > 1 Then
            row(b) = derniereLigne(b - 1) + 5
        End If
        
        derniereLigne(b) = calculLastRow(col, row(b)) + 1
    Next
    
    For b = 1 To 3
        For c = row(b) To derniereLigne(b)
            Range(col & c) = 0
        Next
    Next
    
Next

End Sub



Option Explicit
Option Base 1

Sub procedurePrincipale()

Dim mauvaiseDate As Boolean
Dim dateProposee As Date
mauvaiseDate = False

If wbTemplate <> ActiveWorkbook.name Then
    GoTo arret2
End If

If MsgBox("Do you want to produce FixedIncome statistics?", vbYesNo, "FixedIncome Statistics") = vbNo Then
    Exit Sub
End If

dateProposee = Date - 1
If Weekday(dateProposee) = 7 Then
    dateProposee = dateProposee - 1
ElseIf Weekday(dateProposee) = 1 Then
    dateProposee = dateProposee - 2
End If

dateJour = InputBox("Choose your date dd/mm/yyyy", "Input Date", dateProposee)

If Len(dateJour) <> 8 Then
    mauvaiseDate = True
ElseIf Mid(dateJour, 3, 1) <> "/" Or Mid(dateJour, 6, 1) <> "/" Then
    mauvaiseDate = True
ElseIf Mid(dateJour, 4, 2) > 12 Then
    mauvaiseDate = True
ElseIf Mid(dateJour, 1, 2) > 31 Then
    mauvaiseDate = True
ElseIf Weekday(dateJour) = 7 Or Weekday(dateJour) = 1 Then
    MsgBox "You did not enter a business day ! The " & dateJour & " is a week end day.", vbCritical
    Exit Sub
ElseIf dateJour >= Date Then
    MsgBox "The date must be in the past !", vbCritical
    Exit Sub
End If

If mauvaiseDate = True Then
    MsgBox "Please enter the date according to the format dd/mm/yyyy", vbCritical
    Exit Sub
End If

Call initialiser
Call macroRangement

If arretMacro = True Then
    GoTo arret
End If

Call macroCalculations
Call viderDaily
Call affichageComplet

Workbooks(wbTemplate).Worksheets(wsTemplate1).Activate
Range("A1").Select

Exit Sub
arret:

Exit Sub
arret2:
    MsgBox "Please use this macro from the template file."

End Sub

Sub procedureCopieTemplateS()

If wbTemplate <> ActiveWorkbook.name Then
    GoTo arret2
End If

If dateJour = "00:00:00" Then
    dateJour = Worksheets(wsTemplate1).Range("C2")
End If

Call initialiser
Call rangemenetTemplateSousLeS

If MsgBox("Do you want to send the fixed income statistics by mail to the Fixed Income traders ?", vbYesNo, "Mail") = vbYes Then
    Call genererMail
End If

Call fermerFichier(wbTemplate)

Exit Sub
arret2:
    MsgBox "Please use this macro from the template file."

End Sub
